<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Analytics Futebol Europeu</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- VARI√ÅVEIS E BASE --- */
:root {
  --bg-body: #0f172a;
  --bg-card: #1e293b;
  --bg-input: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --accent: #38bdf8;
  --accent-gradient: linear-gradient(90deg, #38bdf8, #818cf8);
  --border: rgba(255, 255, 255, 0.1);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --radius: 12px;
}

[data-theme="light"] {
  --bg-body: #f1f5f9;
  --bg-card: #ffffff;
  --bg-input: #e2e8f0;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  --accent: #0284c7;
  --accent-gradient: linear-gradient(90deg, #0284c7, #0ea5e9);
  --border: rgba(0, 0, 0, 0.05);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: 'Inter', system-ui, sans-serif;
  background: var(--bg-body);
  color: var(--text-primary);
  transition: background 0.3s;
  padding-bottom: 60px;
}

/* --- HEADER E NAV --- */
header {
  padding: 16px 20px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: blur(10px);
  background: color-mix(in srgb, var(--bg-card), transparent 10%);
}

.brand h1 {
  margin: 0;
  font-size: 1.2rem;
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.last-update { font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px; }

/* Breadcrumb (Navega√ß√£o) */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  display: none; /* Oculto inicialmente */
}
.breadcrumb span { color: var(--text-secondary); cursor: pointer; }
.breadcrumb span:hover { text-decoration: underline; color: var(--accent); }
.breadcrumb strong { color: var(--text-primary); }

.header-actions { display: flex; gap: 8px; }

.icon-btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-primary);
  width: 36px; height: 36px;
  border-radius: 50%;
  display: grid; place-items: center;
  cursor: pointer;
  transition: 0.2s;
}
.icon-btn:active { transform: scale(0.9); }
.rotate { animation: spin 1s linear infinite; }

/* --- CONTROLES --- */
.controls-wrapper {
  padding: 20px 20px 10px;
  max-width: 1200px;
  margin: 0 auto;
}

.tabs {
  display: flex;
  background: var(--bg-input);
  padding: 4px;
  border-radius: var(--radius);
  margin-bottom: 16px;
}
.tabs button {
  flex: 1;
  background: transparent;
  border: none;
  padding: 8px;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 0.8rem;
  border-radius: 8px;
  cursor: pointer;
}
.tabs button.active {
  background: var(--bg-card);
  color: var(--accent);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 1rem;
}

/* --- GRID E CARDS --- */
.section {
  padding: 10px 20px;
  display: grid;
  gap: 20px;
  max-width: 1200px;
  margin: 0 auto;
}
@media(min-width: 768px){ .section{ grid-template-columns: 1fr 1fr; } }

.card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}
.card h2 {
  margin: 0 0 16px;
  font-size: 0.9rem;
  text-transform: uppercase;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}

/* --- RANKING LIST --- */
.row {
  display: grid;
  grid-template-columns: 140px 1fr 50px;
  align-items: center;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid transparent;
}

/* Estilo interativo para linhas clic√°veis (Ligas) */
.clickable-row {
  cursor: pointer;
  border-radius: 6px;
  padding: 8px 6px; /* padding lateral para hover */
  margin: 0 -6px;
  transition: background 0.2s;
}
.clickable-row:hover {
  background: var(--bg-input);
}
.clickable-row .label {
  color: var(--text-primary);
  text-decoration: none;
}
.clickable-row:hover .label {
  color: var(--accent);
}

.label {
  font-size: 0.85rem;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.bar-container {
  height: 8px;
  background: var(--bg-input);
  border-radius: 4px;
  overflow: hidden;
}
.fill {
  height: 100%;
  background: var(--accent-gradient);
  border-radius: 4px;
  width: 0;
  transition: width 1s ease;
}
.value {
  text-align: right;
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--accent);
}

.note {
  color: var(--text-secondary);
  font-size: 0.9rem;
  text-align: center;
  padding: 20px;
  background: var(--bg-input);
  border-radius: var(--radius);
}

/* UTILS */
.hidden { display: none !important; }
#loader {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
  display: flex; flex-direction: column; align-items: center;
  color: var(--text-secondary);
}
.spinner {
  width: 40px; height: 40px; border: 4px solid var(--bg-input);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body data-theme="dark">

<header>
  <div class="brand" id="headerMain">
    <h1>‚öΩ EuroStats</h1>
    <div id="statusUpdate" class="last-update">...</div>
  </div>
  
  <div class="breadcrumb" id="headerNav">
    <span onclick="voltarParaLigas()">In√≠cio</span>
    <div>‚Ä∫</div>
    <strong id="breadcrumbLiga">Liga</strong>
  </div>

  <div class="header-actions">
    <button id="btnRefresh" class="icon-btn" onclick="forcarAtualizacao()">‚Üª</button>
    <button class="icon-btn" onclick="alternarTema()">‚òÄ</button>
  </div>
</header>

<div id="loader"><div class="spinner"></div><small>Processando...</small></div>

<div class="controls-wrapper">
  <div class="tabs">
    <button id="tabFT" class="active" onclick="mudarAba('FT', this)">Tempo Real</button>
    <button id="tabHTFT" onclick="mudarAba('HTFT', this)">HT / FT</button>
    <button id="tabMV" onclick="mudarAba('MV', this)">Casa / Fora</button>
  </div>
  <select id="mercado"></select>
</div>

<div class="section hidden" id="mainContent">
  <div class="card">
    <h2 id="tituloA">Ranking</h2>
    <div id="rankingA"></div>
  </div>
  <div class="card">
    <h2 id="tituloB">Contexto</h2>
    <div id="rankingB"></div>
  </div>
</div>

<script>
// CONFIGURA√á√ïES
const CACHE_KEY = 'eurostats_v2';
const CACHE_TTL = 60 * 60 * 1000;

// ESTRUTURA DE DADOS
let dadosGerais = [];
let ligaAtualIndex = null; // null = vendo todas as ligas, n√∫mero = vendo times da liga
let aba = 'FT';

// DEFINI√á√ÉO DE MERCADOS
const mercados = {
  FT:['mediaGols','zeroZero','over05','under05','over15','under15','over25','under25','vitoriasMandante','vitoriasVisitante','empates','btts'],
  HTFT:['mediaGols','zeroZero','over05','under05','over15','under15','vitoriasMandante','vitoriasVisitante','empates'],
  MV:['vitoriasMandante','vitoriasVisitante','empates','mediaGols']
};

const labels = {
  mediaGols:'M√©dia de Gols',
  zeroZero:'Jogos 0x0',
  over05:'Over 0.5 Gols',
  under05:'Under 0.5 Gols',
  over15:'Over 1.5 Gols',
  under15:'Under 1.5 Gols',
  over25:'Over 2.5 Gols',
  under25:'Under 2.5 Gols',
  vitoriasMandante:'Vit√≥ria Mandante', // Para times: Win at Home
  vitoriasVisitante:'Vit√≥ria Visitante', // Para times: Win Away
  empates:'Empates',
  btts: 'Ambos Marcam (BTTS)'
};

const ligasMap = {
  bundesliga:{nome:'üá©üá™ Bundesliga',url:'https://www.football-data.co.uk/mmz4281/2526/D1.csv',ht:true},
  bundesliga2:{nome:'üá©üá™ Bundesliga 2',url:'https://www.football-data.co.uk/mmz4281/2526/D2.csv',ht:true},
  premier:{nome:'üá¨üáß Premier League',url:'https://www.football-data.co.uk/mmz4281/2526/E0.csv',ht:true},
  premier2:{nome:'üá¨üáß Championship',url:'https://www.football-data.co.uk/mmz4281/2526/E1.csv',ht:true},
  laliga:{nome:'üá™üá∏ La Liga',url:'https://www.football-data.co.uk/mmz4281/2526/SP1.csv',ht:true},
  laliga2:{nome:'üá™üá∏ La Liga 2',url:'https://www.football-data.co.uk/mmz4281/2526/SP2.csv',ht:true},
  seriea:{nome:'üáÆüáπ Serie A',url:'https://www.football-data.co.uk/mmz4281/2526/I1.csv',ht:true},
  seriea2:{nome:'üáÆüáπ Serie B',url:'https://www.football-data.co.uk/mmz4281/2526/I2.csv',ht:true},
  ligue1:{nome:'üá´üá∑ Ligue 1',url:'https://www.football-data.co.uk/mmz4281/2526/F1.csv',ht:true},
  eredivisie:{nome:'üá≥üá± Eredivisie',url:'https://www.football-data.co.uk/mmz4281/2526/N1.csv',ht:true},
  portugal:{nome:'üáµüáπ Liga Portugal',url:'https://www.football-data.co.uk/mmz4281/2526/P1.csv',ht:true},
  scotland:{nome:'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø Premiership',url:'https://www.football-data.co.uk/mmz4281/2526/SC0.csv',ht:true},
  belgium:{nome:'üáßüá™ Pro League',url:'https://www.football-data.co.uk/mmz4281/2526/B1.csv',ht:true},
  turkey:{nome:'üáπüá∑ Super Lig',url:'https://www.football-data.co.uk/mmz4281/2526/T1.csv',ht:true},
  denmark:{nome:'üá©üá∞ Superliga',url:'https://www.football-data.co.uk/new/DNK.csv',ht:false},
  switzerland:{nome:'üá®üá≠ Super League',url:'https://www.football-data.co.uk/new/SWZ.csv',ht:false}
};

// --- CORE: UPDATE & FETCH ---
async function iniciarApp(force = false) {
  document.getElementById('loader').classList.remove('hidden');
  document.getElementById('mainContent').classList.add('hidden');
  
  const cache = localStorage.getItem(CACHE_KEY);
  if (!force && cache) {
    const json = JSON.parse(cache);
    if (Date.now() - json.timestamp < CACHE_TTL) {
      dadosGerais = json.data;
      finalizarLoad(json.timestamp);
      return;
    }
  }
  await baixarDados();
}

async function baixarDados() {
  dadosGerais = [];
  try {
    for(const k in ligasMap){
      // Tenta API, se falhar tenta proxy alternativo
      const url = `https://corsproxy.io/?${encodeURIComponent(ligasMap[k].url)}`;
      const csv = await fetch(url).then(r => r.text());
      const rows = Papa.parse(csv,{header:true}).data;
      dadosGerais.push(processarLiga(rows, ligasMap[k]));
    }
    localStorage.setItem(CACHE_KEY, JSON.stringify({timestamp: Date.now(), data: dadosGerais}));
    finalizarLoad(Date.now());
  } catch(e) {
    console.error(e);
    alert("Erro de conex√£o. Tente novamente.");
    document.getElementById('loader').classList.add('hidden');
  }
}

function finalizarLoad(ts) {
  const date = new Date(ts);
  statusUpdate.textContent = `Atualizado ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
  document.getElementById('loader').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
  document.getElementById('btnRefresh').classList.remove('rotate');
  
  setMercados();
  render();
}

// --- L√ìGICA DE DADOS (AGORA COM TIMES) ---
function processarLiga(rows, infoLiga) {
  // Filtra jogos v√°lidos
  const jogos = rows.filter(r => r.FTHG && r.FTAG);
  
  // Objeto para Estat√≠sticas da Liga
  const statsLiga = newStats();
  
  // Objeto para Estat√≠sticas dos Times
  const times = {};

  jogos.forEach(j => {
    // Dados brutos
    const hg = +j.FTHG; const ag = +j.FTAG;
    const home = j.HomeTeam; const away = j.AwayTeam;
    
    // Inicializa times se n√£o existirem
    if(!times[home]) times[home] = { nome: home, FT: newStats(), HT: newStats() };
    if(!times[away]) times[away] = { nome: away, FT: newStats(), HT: newStats() };

    // Computar Estat√≠sticas FT (Liga e Times)
    computeMatch(statsLiga, hg, ag, j.FTR, 'FT');
    computeMatch(times[home].FT, hg, ag, j.FTR, 'FT', 'Home');
    computeMatch(times[away].FT, hg, ag, j.FTR, 'FT', 'Away');

    // Computar Estat√≠sticas HT (Se houver)
    if(infoLiga.ht && j.HTHG && j.HTAG) {
      const hhg = +j.HTHG; const hag = +j.HTAG;
      computeMatch(statsLiga, hhg, hag, j.HTR, 'HT');
      computeMatch(times[home].HT, hhg, hag, j.HTR, 'HT', 'Home');
      computeMatch(times[away].HT, hhg, hag, j.HTR, 'HT', 'Away');
    }
  });

  // Converter contagens absolutas em porcentagens
  const processadoLiga = converterParaPct(statsLiga, jogos.length);
  const processadoTimes = Object.values(times).map(t => ({
    nome: t.nome,
    FT: converterParaPct(t.FT, t.FT.total),
    HT: converterParaPct(t.HT, t.HT.total)
  }));

  return {
    nome: infoLiga.nome,
    ht: infoLiga.ht,
    FT: processadoLiga.FT,
    HT: processadoLiga.HT,
    times: processadoTimes // Array com stats de cada time
  };
}

function newStats() {
  return { 
    total:0, gols:0, z:0, o05:0, o15:0, o25:0, btts:0,
    vm:0, vv:0, e:0 // Vit√≥rias/Empates
  };
}

function computeMatch(obj, g1, g2, res, type, side = null) {
  const tg = g1 + g2;
  obj.total++;
  obj.gols += tg;
  
  if(tg === 0) obj.z++;
  if(tg >= 1) obj.o05++;
  if(tg >= 2) obj.o15++;
  if(tg >= 3) obj.o25++;
  if(g1 > 0 && g2 > 0) obj.btts++;

  // L√≥gica de Vit√≥ria (Depende se √© stats da Liga ou do Time)
  // Se side == null (Liga), VM = Home Win.
  // Se side == 'Home' (Time), VM = Ganhou.
  // Se side == 'Away' (Time), VV = Ganhou.
  
  if (side === null) {
    if(res === 'H') obj.vm++;
    else if(res === 'A') obj.vv++;
    else obj.e++;
  } else {
    // Para times, mapeamos VM como "Vit√≥ria jogando em Casa" e VV "Vit√≥ria jogando Fora"
    // Mas para simplificar a tabela unificada, usaremos:
    // vm = ganhou o jogo (independente de onde) se estivermos na aba GERAL? 
    // N√£o, vamos manter a sem√¢ntica do Select:
    
    // Se estou processando o time Home e o resultado foi H -> Vit√≥ria Mandante
    if(side === 'Home' && res === 'H') obj.vm++;
    if(side === 'Away' && res === 'A') obj.vv++; 
    if(res === 'D') obj.e++;
  }
}

function converterParaPct(obj, total) {
  const t = total || 1;
  const p = x => (x / t * 100).toFixed(1);
  return {
    mediaGols: (obj.gols / t).toFixed(2),
    zeroZero: p(obj.z),
    over05: p(obj.o05),
    under05: p(t - obj.o05),
    over15: p(obj.o15),
    under15: p(t - obj.o15),
    over25: p(obj.o25),
    under25: p(t - obj.o25),
    btts: p(obj.btts),
    vitoriasMandante: p(obj.vm),
    vitoriasVisitante: p(obj.vv),
    empates: p(obj.e)
  };
}

// --- RENDERIZA√á√ÉO ---
function render() {
  rankingA.innerHTML = '';
  rankingB.innerHTML = '';
  const m = mercado.value;

  // Header Contextual
  if(ligaAtualIndex === null) {
    // VIS√ÉO DE LIGAS
    tituloA.textContent = `Ranking de Ligas (${m})`;
    tituloB.textContent = 'Dica';
    rankingB.innerHTML = '<div class="note">Toque em uma liga para ver as estat√≠sticas individuais dos times.</div>';
    
    renderList(dadosGerais, m, true); // true = isLiga
    toggleNav(false);
  } else {
    // VIS√ÉO DE TIMES
    const liga = dadosGerais[ligaAtualIndex];
    tituloA.textContent = `Times: ${labels[m]}`;
    
    // Contexto Lateral: Mostra a m√©dia da liga para compara√ß√£o
    tituloB.textContent = 'M√©dia da Liga';
    const mediaLiga = getVal(liga, aba, m);
    rankingB.innerHTML = `
      <div style="text-align:center; padding:20px">
        <div style="font-size:3rem; font-weight:700; color:var(--accent)">${mediaLiga}${m==='mediaGols'?'':'%'}</div>
        <div style="color:var(--text-secondary)">${liga.nome}</div>
      </div>
      <div class="note">Isso indica se o time est√° acima ou abaixo da tend√™ncia do campeonato.</div>
    `;

    renderList(liga.times, m, false); // false = isTeam
    toggleNav(true, liga.nome);
  }
  
  animarBarras();
}

function renderList(lista, m, isLiga) {
  // Filtra nulls se for HT
  let items = lista;
  if(aba === 'HTFT') items = lista.filter(x => x.HT);

  // Ordena√ß√£o
  items.sort((a,b) => getVal(b, aba, m) - getVal(a, aba, m));
  
  // Escala para barra gr√°fica
  const max = Math.max(...items.map(i => +getVal(i, aba, m)));

  items.forEach((item, idx) => {
    // Se for vis√£o de Ligas, precisamos saber o √≠ndice original para o clique
    const realIndex = isLiga ? dadosGerais.indexOf(item) : null;
    const val = getVal(item, aba, m);
    
    rankingA.innerHTML += row(
      item.nome, 
      val, 
      max, 
      m === 'mediaGols', 
      isLiga, 
      realIndex
    );
  });
}

function getVal(obj, abaRef, key) {
  // Se aba for MV, usamos FT.vitoriasMandante (exemplo) ou logica especifica
  // Para simplificar, mapeamos MV para FT exceto se quisermos separar Home/Away stats reais
  // Neste c√≥digo simplificado, MV usa as keys de FT que separam mandante/visitante
  const ref = abaRef === 'HTFT' ? 'HT' : 'FT';
  return obj[ref] ? obj[ref][key] : 0;
}

function row(nome, val, max, isMedia, isClickable, index) {
  const width = (val / max) * 100;
  const clickAttr = isClickable ? `onclick="abrirLiga(${index})"` : '';
  const classRow = isClickable ? 'row clickable-row' : 'row';
  const suffix = isMedia ? '' : '<small>%</small>';
  
  return `
  <div class="${classRow}" ${clickAttr}>
    <div class="label" title="${nome}">${nome}</div>
    <div class="bar-container">
      <div class="fill" data-width="${width}%"></div>
    </div>
    <div class="value">${val}${suffix}</div>
  </div>`;
}

// --- NAVEGA√á√ÉO ---
function abrirLiga(index) {
  ligaAtualIndex = index;
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function voltarParaLigas() {
  ligaAtualIndex = null;
  render();
}

function toggleNav(showBreadcrumb, nomeLiga = '') {
  if(showBreadcrumb) {
    document.getElementById('headerMain').classList.add('hidden');
    document.getElementById('headerNav').style.display = 'flex';
    document.getElementById('breadcrumbLiga').textContent = nomeLiga;
  } else {
    document.getElementById('headerMain').classList.remove('hidden');
    document.getElementById('headerNav').style.display = 'none';
  }
}

function mudarAba(nova, btn) {
  aba = nova;
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  setMercados();
  render();
}

function setMercados() {
  const sel = document.getElementById('mercado');
  const valAtual = sel.value;
  sel.innerHTML = '';
  mercados[aba].forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = labels[k];
    sel.appendChild(opt);
  });
  // Tenta manter a sele√ß√£o se poss√≠vel
  if(mercados[aba].includes(valAtual)) sel.value = valAtual;
}

function animarBarras() {
  setTimeout(() => {
    document.querySelectorAll('.fill').forEach(el => el.style.width = el.dataset.width);
  }, 50);
}

document.getElementById('mercado').onchange = render;

function forcarAtualizacao() {
  document.getElementById('btnRefresh').classList.add('rotate');
  iniciarApp(true);
}
function alternarTema() {
  document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
}

iniciarApp();
</script>
</body>
</html>
